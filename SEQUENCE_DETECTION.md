# نظام كشف تسلسل الآيات (Sequence Detection System)

## نظرة عامة

نظام لمراقبة تسلسل الآيات أثناء التسميع، يكتشف القفز أو الخلط في ترتيب الآيات دون محاولة تصحيح التجويد أو الحركات.

## الأهداف

1. **كشف القفز للأمام**: عندما يتخطى الطالب آية أو أكثر
2. **كشف عدم التطابق**: عندما يقرأ الطالب من صفحة أخرى
3. **كشف الرجوع غير المنطقي**: عندما يرجع الطالب للخلف بشكل كبير

## المكونات الجديدة

### 1. Backend Components

#### `backend/sequence_analyzer.py`
محلل تسلسل الآيات الرئيسي:

**Classes:**
- `SequenceError`: يمثل خطأ تسلسلي تم اكتشافه
- `SequenceAnalyzer`: المحلل الرئيسي

**Key Methods:**
- `analyze()`: يحلل نتيجة المطابقة للكشف عن أخطاء التسلسل
- `_analyze_skipped_region()`: يحلل المنطقة المتخطّاة لتحديد الآيات
- `should_alert()`: يحدد ما إذا كان يجب إصدار تنبيه للمستخدم

**Error Types:**
- `skip_aya`: تخطي آية أو أكثر
- `page_mismatch`: التلاوة لا تطابق الصفحة الحالية
- `backwards_anomaly`: رجوع غير منطقي للخلف

#### التعديلات على `backend/config.py`
 إعدادات قابلة للضبط:

```python
SEQUENCE_SKIP_MIN_WORDS = 12  # الحد الأدنى للكلمات لاعتبارها قفزة
SEQUENCE_SKIP_MIN_AYAS = 1    # الحد الأدنى للآيات الكاملة
SEQUENCE_BACKWARDS_TOLERANCE = 3  # السماح بالرجوع لهذا العدد من الكلمات
SEQUENCE_LOW_CONFIDENCE_THRESHOLD = 0.3  # عتبة الثقة المنخفضة
SEQUENCE_MIN_SEGMENT_SCORE = 0.4  # الحد الأدنى لدرجة المقطع
SEQUENCE_ALERT_MIN_CONFIDENCE = 0.5  # الحد الأدنى للثقة لإصدار تنبيه
```


## كيف يعمل النظام؟

### 1. تحليل التسلسل
عند استقبال كل قطعة صوتية:

1. يحفظ الموضع السابق (`prev_pos`)
2. يحصل على نتيجة المطابقة من `QuranAlignmentEngine`
3. يستخرج الكلمات الصحيحة ويحسب `min_idx` و `max_idx`
4. يحسب الفجوة: `gap = min_idx - prev_pos`

### 2. اكتشاف القفز
إذا كان `gap >= SEQUENCE_SKIP_MIN_WORDS`:
- يحلل المنطقة المتخطّاة
- يحدد الآيات المتأثرة
- يتحقق من أن عدد الآيات >= `SEQUENCE_SKIP_MIN_AYAS`
- يصدر `skip_aya` error

### 3. اكتشاف عدم التطابق
إذا كانت الثقة منخفضة لعدة تشَنكات متتالية:
- `consecutive_low_confidence >= 3`
- `confidence < SEQUENCE_LOW_CONFIDENCE_THRESHOLD`
- `segment_score < SEQUENCE_MIN_SEGMENT_SCORE`
- يصدر `page_mismatch` error

### 4. العرض البصري
- **تلوين الآيات المتخطّاة**: باللون الأصفر مع تأثير نبض
- **رسالة تحذير**: تظهر أعلى المصحف مع إمكانية الإغلاق
- **تمييز بصري**: حسب نوع الخطأ (warning/error)

## أمثلة الاستخدام

### مثال 1: تخطي آية واحدة
```
الصحيح: آية 10 → آية 11 → آية 12
الطالب قرأ: آية 10 → آية 12 (تخطى 11)

النتيجة:
- تلوين آية 11 باللون الأصفر
- رسالة: "تم تخطي الآية رقم 11. يرجى إعادة التلاوة من الموضع الصحيح."
```

### مثال 2: تخطي عدة آيات
```
الصحيح: آيات 6-16 بالترتيب
الطالب قرأ: حتى آية 11 ثم قفز إلى آية 14

النتيجة:
- تلوين آيات 12-13 باللون الأصفر
- رسالة: "تم تخطي الآيات من 12 إلى 13. يرجى إعادة التلاوة من الموضع الصحيح."
```

### مثال 3: قراءة من صفحة أخرى
```
الطالب يقرأ من صفحة 5 لكن النظام على صفحة 3

النتيجة:
- رسالة خطأ حمراء: "التلاوة الحالية لا تطابق آيات هذه الصفحة. تأكد أنك تقرأ من نفس الموضع."
```

## ضبط الحساسية

### زيادة الحساسية (اكتشاف قفزات أصغر)
```python
SEQUENCE_SKIP_MIN_WORDS = 8
SEQUENCE_ALERT_MIN_CONFIDENCE = 0.4
```

### تقليل الحساسية (تجنب الإنذارات الكاذبة)
```python
SEQUENCE_SKIP_MIN_WORDS = 15
SEQUENCE_ALERT_MIN_CONFIDENCE = 0.6
```

## الفوائد

1. **واقعي**: لا يدّعي تصحيح التجويد، فقط يتتبع الموضع
2. **مفيد**: يساعد الطلاب على الالتزام بالترتيب الصحيح
3. **قابل للضبط**: عتبات مرنة حسب الاحتياجات
4. **بصري واضح**: تنبيهات واضحة وسهلة الفهم
5. **غير متطفل**: لا يوقف التسميع، فقط ينبّه

## القيود والملاحظات

1. **لا يكتشف أخطاء التجويد**: النظام لا يصحح المد/الغنة/الإدغام
2. **لا يكتشف أخطاء الحركات**: النظام لا يصحح الفتحة/الضمة/الكسرة
3. **يعتمد على ASR**: دقة الكشف تعتمد على جودة نموذج التعرف على الكلام
4. **قد تحدث إنذارات كاذبة**: خاصة مع صوت غير واضح أو ضوضاء

## التطوير المستقبلي

1. إضافة إحصائيات للجلسة (عدد القفزات، الآيات المتخطّاة)
2. حفظ سجل الأخطاء لكل طالب
3. وضع "صارم" يوقف التسميع عند أول خطأ
4. تكامل مع نظام تقييم أو تقارير للمعلمين
5. دعم التسميع عبر صفحات متعددة

## الاختبار

للاختبار، جرّب السيناريوهات التالية:

1. **اختبار القفز**: اقرأ آيات 1-5 ثم اقفز مباشرة لآية 10
2. **اختبار الصفحة الخاطئة**: افتح صفحة 3 واقرأ من صفحة 5
3. **اختبار الرجوع**: اقرأ آيات 1-10 ثم ارجع لآية 3
4. **اختبار التسلسل الصحيح**: اقرأ الصفحة كاملة بالترتيب (لا يجب أن يظهر أي تنبيه)

## الدعم الفني

إذا واجهت مشاكل:
1. تحقق من ملف `backend/config.py` وعدّل العتبات
2. راجع logs الخادم للحصول على تفاصيل أكثر
3. تأكد من جودة الصوت والميكروفون
4. جرّب تقليل `SEQUENCE_SKIP_MIN_WORDS` إذا لم تُكتشف القفزات
5. جرّب زيادة `SEQUENCE_ALERT_MIN_CONFIDENCE` إذا كانت هناك إنذارات كثيرة كاذبة

